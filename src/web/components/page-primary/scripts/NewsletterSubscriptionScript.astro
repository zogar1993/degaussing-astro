<script>
	const newsletterSection = document.getElementById("newsletter")
	const newsletterInput = document.getElementById("newsletter-input")
	const newsletterButton = document.getElementById("newsletter-button")
	const newsletterForm = document.getElementById("newsletter-form")

	const formObserver = new IntersectionObserver((entries) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				const script = document.createElement("script")
				script.src = "https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad"
				script.async = true
				document.head.appendChild(script)
				formObserver.unobserve(newsletterSection)
			}
		})
	})

	formObserver.observe(newsletterSection)

	window.onNewsletterSubscription = () => {
		const formData = new FormData(newsletterForm)

		newsletterSection.dataset.state = "waiting-server-confirmation"
		newsletterButton.disabled = true

		fetch(newsletterForm.getAttribute("action"), {
			method: "POST",
			body: formData
		})
			.then(response => response.json())
			.then(data => {
				if (data.success)
					newsletterSection.dataset.state = "success"
				else
					newsletterSection.dataset.state = "error"
			})
			.catch(() => {
				newsletterSection.dataset.state = "error"
			})
	}

	window.onRecaptchaLoad = () => {
		newsletterButton.disabled = true
	}

	newsletterInput.addEventListener("input", () => {
		const isValid = newsletterInput.value.length > 0 && newsletterInput.checkValidity()
		newsletterButton.disabled = !isValid
	})
</script>